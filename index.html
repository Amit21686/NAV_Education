<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NAV Education</title>
 
  <!-- PWA Manifest -->
  <link rel="manifest" href="/NAV_Education/manifest.json">
  <meta name="theme-color" content="#0d6efd">

  <!-- Service Worker Script -->
  <script src="/NAV_Education/script.js" defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .progress-bar {
      height: 6px;
      background-color: #e2e8f0;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(to right, #4f46e5, #7c3aed);
      transition: width 0.5s ease;
    }
    
    .option-card {
      transition: all 0.2s ease;
    }
    
    .option-card:hover {
      background-color: #f0f4ff;
      border-color: #4f46e5;
    }
    
    .option-card.selected {
      background-color: #e0e7ff;
      border-color: #4f46e5;
    }
    
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
      100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
    }
    
    .result-card {
      background: linear-gradient(145deg, #ffffff, #f5f7ff);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(79, 70, 229, 0.1);
    }
    
    .result-divider {
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(79, 70, 229, 0.3), transparent);
      margin: 1rem 0;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-100 flex flex-col">
  <div id="app" class="flex-grow flex flex-col max-w-4xl mx-auto p-4 md:p-6 fade-in"></div>

  <script>
    // =============================================
    // DATA CONFIGURATION - EDIT THIS SECTION TO ADD NEW SUBJECTS
    // =============================================
    
    /*
    HOW TO ADD A NEW SUBJECT:
    
    1. Add your subject name to the data object
    2. Add chapters array with id, title, and notes (optional)
    3. Add quiz questions for EACH CHAPTER in quizQuestions
    4. Add subject icon in getSubjectIcon function
    5. Update timedTestChapters if you want timed tests for specific chapters
    */
    const extraSubjects = [
  {
    name: "Verbs",
    display: "Verbs Practice File",
    type: "Special",
    url: "Verbs.html"
  },
  {
    name: "India Map",
    display: "India Map",
    type: "Special",
    url: "india.html"
  },
  {
    name: "Gujarat Map",
    display: "Gujarat Map",
    type: "Special",
    url: "gujarat.html"
  }
];
    
    const data = {
      Biology: {
        chapters: [
          {
            id: 1,
            title: "1. Cell Structure and Function",
            notes: `Cells are the basic structural and functional units of life. All living organisms are composed of cells...`
          },
          {
            id: 2,
            title: "2. Genetics", 
            notes: "Genetics is the study of heredity and variation of inherited characteristics..."
          }
        ]
      },
      
      Computer: {
        chapters: [
          {
            id: 1,
            title: "1. Creating HTML forms using KompoZer "
            // No notes - only practice and timed test
          },
          {
            id: 2,
            title: "2. Data Structures"
            // No notes - only practice and timed test
          },
          {
            id: 3,
            title: "3. Database Management"
            // No notes - only practice and timed test  
          }
        ]
      },
      
"STD 6th": {
        chapters: [
          {
            id: 1,
            title: "1. Evolution ",
               notes: `<b>Evolution</b> is the process by which living things have changed over time. All plants and animals that exist today have developed from earlier forms through a long, gradual process.

<span class="text-indigo-600 font-semibold">Key Points:</span>
<ul class="list-disc ml-6">
  <li><b>Evolution</b> explains how simple life forms developed into more complex ones.</li>
  <li>The changes in living things happen over <b>millions of years</b>.</li>
  <li>Scientists study <b>fossils</b> to learn about how plants and animals have changed.</li>
  <li>Fossils are the remains or imprints of ancient living things found in rocks.</li>
  <li>The famous scientist <b>Charles Darwin</b> gave the idea of <span class="text-indigo-600 font-semibold">natural selection</span>, which explains how evolution happens.</li>
</ul>

<span class="text-indigo-600 font-semibold">Important Terms:</span>
<ul class="list-disc ml-6">
  <li><b>Adaptation:</b> The special features or behaviors that help a living thing survive in its environment.</li>
  <li><b>Species:</b> A group of similar living things that can reproduce with each other.</li>
  <li><b>Natural Selection:</b> The process where only the living things best suited to their environment survive and reproduce.</li>
</ul>

<b>Summary:</b><br>
Evolution is a slow and natural process that has led to the diversity of life we see today. By studying fossils and living things, we can understand how life has changed over time and how different species have come to exist....`
            // No notes - only practice and timed test
          },
          {
            id: 2,
            title: "2. Living Organism"
            // No notes - only practice and timed test
          }
    
        ]
            
},
      // TO ADD ANOTHER SUBJECT, COPY THE TEMPLATE BELOW:
      /*
      "Your Subject Name": {
        chapters: [
          {
            id: 1,
            title: "1. Chapter One Title",
            notes: "Your chapter notes here..." // Remove notes property if you don't want study notes
          }
        ]
      }
      */
    };

    // =============================================
    // CHAPTER-WISE QUIZ QUESTIONS - ADD QUESTIONS FOR EACH CHAPTER
    // =============================================
    
    /*
    FORMAT FOR ADDING CHAPTER-WISE QUIZ QUESTIONS:
    
    "Subject Name": {
      "chapterId": [
        {
          question: "Your question here?",
          options: ["Option A", "Option B", "Option C", "Option D"],
          answer: 0 // Index of correct option (0-3)
        }
      ]
    }
    */
    
    const quizQuestions = {
      Biology: {
        1: [ // Chapter 1 - Cell Structure
          {
            question: "What is the powerhouse of the cell?",
            options: ["Nucleus", "Mitochondria", "Ribosome", "Endoplasmic Reticulum"],
            answer: 1
          },
          {
            question: "Which organelle contains the genetic material?",
            options: ["Cytoplasm", "Mitochondria", "Nucleus", "Cell Membrane"],
            answer: 2
          },
          {
            question: "Ribosomes are responsible for:",
            options: ["DNA replication", "Protein synthesis", "Lipid synthesis", "Energy production"],
            answer: 1
          }
          // Add more Chapter 1 questions here...
        ],
        2: [ // Chapter 2 - Genetics
          {
            question: "What is the basic unit of heredity?",
            options: ["Chromosome", "Gene", "DNA", "Cell"],
            answer: 1
          },
          {
            question: "How many chromosomes do humans have?",
            options: ["23", "46", "32", "64"],
            answer: 1
          }
          // Add more Chapter 2 questions here...
        ]
      },
      
      Computer: {
        1: [ // Chapter 1 - Introduction to Programming
       {
      question: "According to the text, what is the primary purpose of HTML forms?",
      options: ["To make websites more visually appealing", "To help visitors of a website input data", "To display dynamic news content", "To increase the speed of a website"],
      answer: 1
    },
    {
      question: "Which of these real-world examples is explicitly mentioned as using an HTML form?",
      options: ["Making an online purchase", "Opening a mail account", "Posting on social media", "Searching the web"],
      answer: 1
    },
    {
      question: "After a form is submitted, the collected data is:",
      options: ["Displayed publicly on the website", "Used to setup an account for the user", "Immediately deleted for privacy", "Sent to every registered user"],
      answer: 1
    },
    {
      question: "In HTML, a form is best described as a:",
      options: ["Programming script", "Special kind of table", "Container for different kinds of inputs", "Database connection"],
      answer: 2
    },
    {
      question: "Which of the following elements is NOT listed in the text as being contained within an HTML form?",
      options: ["Textarea", "Select and Option", "Form", "Video"],
      answer: 3
    },
    {
      question: "What is the function of the <form>...</form> tag?",
      options: ["It creates a single input field", "It implements the form element as a container", "It defines the header of the web page", "It styles the form with colors"],
      answer: 1
    },
    {
      question: "The action attribute in a form tag is used to specify:",
      options: ["The color scheme of the form", "Where to send the form data when submitted", "The type of data that can be entered", "The name of the form"],
      answer: 1
    },
    {
      question: "What kind of value does the action attribute take?",
      options: ["A color code", "A number", "A filename", "A font name"],
      answer: 2
    },
    {
      question: "The method attribute in a form tag specifies:",
      options: ["The type of input validation to use", "The language to write the form in", "The HTTP method to be used when sending the data", "The number of fields in the form"],
      answer: 2
    },
    {
      question: "What happens when a user clicks the submit button on a form?",
      options: ["The form data is cleared", "The web page is reloaded with no data", "The file specified in the action attribute is opened", "The form is hidden from view"],
      answer: 2
    },
    {
      question: "Besides entering data, what is the other use for form elements mentioned in the text?",
      options: ["To encrypt the data for security", "To validate the data within the forms", "To compress the data for faster transmission", "To display the data in a chart"],
      answer: 1
    },
    {
      question: "Which form element is used to create a multi-line text input field?",
      options: ["Input", "Textarea", "Select", "Option"],
      answer: 1
    },
    {
      question: "The 'Select and Option' elements are used to create what kind of form control?",
      options: ["A large text box", "A clickable button", "A drop-down list for selection", "A checkbox"],
      answer: 2
    },
    {
      question: "Who or what stores the data collected from an HTML form?",
      options: ["The user's web browser", "The website visitor", "The application", "The computer's operating system"],
      answer: 2
    },
    {
      question: "The text states that the increase in Internet use has caused many activities to become:",
      options: ["More expensive", "More secure", "Online", "Slower"],
      answer: 3
    }
          // Add more Chapter 1 questions here...
        ],
        2: [ // Chapter 2 - Data Structures
          {
            question: "Which data structure uses LIFO principle?",
            options: ["Queue", "Stack", "Array", "Linked List"],
            answer: 1
          },
          {
            question: "What is the time complexity of binary search?",
            options: ["O(1)", "O(n)", "O(log n)", "O(n²)"],
            answer: 2
          }
          // Add more Chapter 2 questions here...
        ],
        3: [ // Chapter 3 - Database Management
          {
            question: "What does SQL stand for?",
            options: ["Structured Query Language", "Simple Question Language", "System Query Logic", "Structured Question Logic"],
            answer: 0
          },
          {
            question: "Which SQL command is used to retrieve data?",
            options: ["GET", "SELECT", "RETRIEVE", "FIND"],
            answer: 1
          }
          // Add more Chapter 3 questions here...
        ]
      }
      
      // TO ADD QUESTIONS FOR ANOTHER SUBJECT:
      /*
      "Your Subject Name": {
        1: [ // Chapter 1
          {
            question: "Your question here?",
            options: ["Option A", "Option B", "Option C", "Option D"],
            answer: 0
          }
        ],
        2: [ // Chapter 2
          // Questions for chapter 2
        ]
      }
      */
    };

    // =============================================
    // APP STATE - NO NEED TO EDIT THIS SECTION
    // =============================================
    
    let state = {
      currentView: 'subjectSelection',
      selectedSubject: null,
      selectedChapter: null,
      selectedMode: null,
      studentName: '',
      testAnswers: [],
      timerInterval: null,
      timerSecondsLeft: 300,
      testSubmitted: false,
      telegramMessageStatus: null,
      currentQuestionIndex: 0
    };

    const TELEGRAM_BOT_TOKEN = "7876285536:AAEdt1KLNJ_jW8fzbbiG7X_08sro2kzWnPk";
    const TELEGRAM_CHAT_ID = "6071885031";

    const app = document.getElementById('app');

    // =============================================
    // UTILITY FUNCTIONS - EDIT ICONS AND TIMED TEST SETTINGS
    // =============================================
    
    // HTML escaping for Telegram
    function escapeHtml(text) {
      if (!text) return '';
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // Format time as MM:SS
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60).toString().padStart(2, '0');
      const s = (seconds % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    // Get current chapter
    function getSelectedChapter() {
      const chapters = data[state.selectedSubject]?.chapters || [];
      return chapters.find(ch => ch.id === state.selectedChapter) || {};
    }

    // Get current chapter's quiz questions
    function getCurrentQuizQuestions() {
      const subjectQuestions = quizQuestions[state.selectedSubject];
      if (!subjectQuestions) return [];
      return subjectQuestions[state.selectedChapter] || [];
    }

    // =============================================
    // SUBJECT ICONS - ADD ICONS FOR NEW SUBJECTS HERE
    // =============================================
    
    function getSubjectIcon(subject) {
      const icons = {
        'Biology': 'dna',
        'Computer': 'laptop-code'
        // ADD NEW SUBJECT ICONS HERE:
        // 'Your Subject': 'icon-name'
      };
      return icons[subject] || 'book';
    }

    // =============================================
    // TIMED TEST SETTINGS - EDIT TO ALLOW TIMED TESTS FOR MORE CHAPTERS
    // =============================================
    
    /*
    FORMAT: 
    'Subject Name': [chapterId1, chapterId2, ...]
    */
    
    const timedTestChapters = {
      'Biology': [1, 2],
      'Computer': [1, 2, 3]
      // ADD MORE SUBJECTS/CHAPTERS FOR TIMED TESTS:
      // 'Your Subject': [1, 2, 3]
    };

    function isTimedTestAllowed() {
      return timedTestChapters[state.selectedSubject]?.includes(state.selectedChapter) || false;
    }
// ====== GLOBAL SEARCH INDEX & FUNCTION ======
function buildSearchIndex() {
  const index = [];
  for (const [subject, subjObj] of Object.entries(data)) {
    // Subject
    index.push({
      type: 'Subject',
      subject,
      content: subject,
      display: `Subject: <b>${subject}</b>`,
      ref: {subject}
    });
    // Chapters and notes
    for (const chapter of subjObj.chapters) {
      index.push({
        type: 'Chapter',
        subject,
        chapter: chapter.title,
        content: chapter.title,
        display: `Chapter: <b>${chapter.title}</b> <i>in ${subject}</i>`,
        ref: {subject, chapterId: chapter.id}
      });
      if (chapter.notes) {
        index.push({
          type: 'Notes',
          subject,
          chapter: chapter.title,
          content: chapter.notes,
          display: `Notes in <b>${chapter.title}</b> (${subject})`,
          ref: {subject, chapterId: chapter.id}
        });
      }
    }
  }

  for (const item of extraSubjects) {
  index.push({
    type: item.type,
    subject: item.name,
    content: item.name + " " + item.display,
    display: `Special: <b>${item.display}</b>`,
    url: item.url
  });
}
  
  // Quiz questions and options
  for (const [subject, chapters] of Object.entries(quizQuestions)) {
    for (const [chapterId, qs] of Object.entries(chapters)) {
      for (const q of qs) {
        index.push({
          type: 'Question',
          subject,
          chapterId,
          content: q.question,
          display: `Question: <b>${q.question}</b> <i>in ${subject}, Chapter ${chapterId}</i>`,
          ref: {subject, chapterId: Number(chapterId)}
        });
        for (let oi = 0; oi < q.options.length; oi++) {
          index.push({
            type: 'Option',
            subject,
            chapterId,
            content: q.options[oi],
            display: `Option: <b>${q.options[oi]}</b> (Q: ${q.question}) <i>in ${subject}, Chapter ${chapterId}</i>`,
            ref: {subject, chapterId: Number(chapterId)}
          });
        }
      }
    }
  }
  return index;
}

const searchIndex = buildSearchIndex();

function performSearch(query) {
  query = query.trim().toLowerCase();
  if (!query) return [];
  return searchIndex.filter(item => item.content.toLowerCase().includes(query));
}

    
    // =============================================
    // RENDER FUNCTIONS - NO NEED TO EDIT BELOW THIS LINE
    // =============================================
    
    // Render dispatcher
    function render() {
      switch(state.currentView) {
        case 'subjectSelection': renderSubjectSelection(); break;
        case 'chapterList': renderChapterList(); break;
        case 'chapterOptions': renderChapterOptions(); break;
        case 'notesView': renderNotesView(); break;
        case 'quizModeSelection': renderQuizModeSelection(); break;
        case 'practiceModeFlashcards': renderPracticeModeFlashcards(); break;
        case 'timedTest': renderTimedTest(); break;
        case 'testResults': renderTestResults(); break;
      }
    }

    function clearTimer() {
      if(state.timerInterval) {
        clearInterval(state.timerInterval);
        state.timerInterval = null;
      }
    }

    // Subject Selection View
    function renderSubjectSelection() {
      app.innerHTML = `
        <div class="flex flex-col items-center space-y-6 md:space-y-8">
          <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg overflow-hidden card-hover">
            <img src="https://iili.io/K1fpl5J.md.png" alt="NAV Education Banner" class="w-full h-auto" />
          </div>
          
          <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 mb-2">NAV Education</h1>
            <p class="text-gray-600 max-w-md">Chapter-wise learning platform</p>
          </div>
<div class="w-full max-w-2xl mx-auto mb-8">
  <form id="globalSearchForm" class="flex items-center bg-white rounded-full shadow-sm px-3 py-2 mb-2 ring-1 ring-indigo-100" autocomplete="off" onsubmit="return false;">
    <i class="fas fa-search text-gray-400 text-xl mr-2"></i>
    <input 
      id="globalSearchInput"
      class="flex-1 outline-none border-none bg-transparent px-2 py-1 text-gray-700 text-lg"
      type="text"
      placeholder="Search anything (chapter, notes, question...)"
      autocomplete="off"
    />
    <button type="submit" class="hidden"></button>
  </form>
  <div id="globalSearchResults" class="bg-white rounded-xl shadow-md mt-1 max-h-80 overflow-y-auto hidden"></div>
</div>

          <div class="w-full">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Select Your Subject</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-6">
<a 
  href="Verbs.html"
  target="_blank"
  rel="noopener"
  class="bg-white rounded-xl p-6 text-center shadow-md card-hover flex flex-col items-center justify-center h-32 md:h-40 focus:outline-none focus:ring-4 focus:ring-blue-200 transition-all"
  style="text-decoration: none;"
>
  <i class="fas fa-language text-3xl mb-3 text-blue-600"></i>
  <span class="font-semibold text-gray-800">Open Verbs</span>
  <p class="text-xs text-gray-500 mt-1">Verbs Practice File</p>
</a>

<!-- India Map Button -->
<a 
  href="india.html"
  class="bg-white rounded-xl p-6 text-center shadow-md card-hover flex flex-col items-center justify-center h-32 md:h-40 focus:outline-none focus:ring-4 focus:ring-green-200 transition-all"
  style="text-decoration: none;"
>
  <i class="fas fa-map-marked-alt text-3xl mb-3 text-green-600"></i>
  <span class="font-semibold text-gray-800">India Map</span>
  <p class="text-xs text-gray-500 mt-1">Click to view</p>
</a>

            <!-- Gujarat Map Button -->
<a 
  href="gujarat.html"
  class="bg-white rounded-xl p-6 text-center shadow-md card-hover flex flex-col items-center justify-center h-32 md:h-40 focus:outline-none focus:ring-4 focus:ring-green-200 transition-all"
  style="text-decoration: none;"
>
  <i class="fas fa-map-marked-alt text-3xl mb-3 text-green-600"></i>
  <span class="font-semibold text-gray-800">Gujarat Map</span>
  <p class="text-xs text-gray-500 mt-1">Click to view</p>
</a>
<a 
  href="https://amit21686.github.io/NAV_Education/L1.pdf"
  target="_blank"
  rel="noopener"
  class="bg-white rounded-xl p-6 text-center shadow-md card-hover flex flex-col items-center justify-center h-32 md:h-40 focus:outline-none focus:ring-4 focus:ring-indigo-200 transition-all"
  style="text-decoration: none;"
>
  <i class="fas fa-file-pdf text-3xl mb-3 text-red-600"></i>
  <span class="font-semibold text-gray-800">Open L1.pdf</span>
  <p class="text-xs text-gray-500 mt-1">Best mobile-friendly view</p>
</a>


              ${Object.keys(data).map(subject => `
                <button
                  class="bg-white rounded-xl p-6 text-center shadow-md card-hover flex flex-col items-center justify-center h-32 md:h-40 focus:outline-none focus:ring-4 focus:ring-indigo-200 transition-all duration-300"
                  onclick="onSubjectSelect('${subject}')"
                >
                  <i class="fas fa-${getSubjectIcon(subject)} text-3xl mb-3 text-indigo-600"></i>
                  <span class="font-semibold text-gray-800">${subject}</span>
                  <p class="text-xs text-gray-500 mt-1">${data[subject].chapters.length} chapters</p>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // Chapter List View
    function renderChapterList() {
      const chapters = data[state.selectedSubject]?.chapters || [];
      const subjectQuestions = quizQuestions[state.selectedSubject] || {};
      
      app.innerHTML = `
        <div class="flex flex-col fade-in">
          <div class="flex items-center mb-6">
            <button class="flex items-center text-indigo-600 hover:text-indigo-800 font-medium transition-colors" onclick="onBackToSubjects()">
              <i class="fas fa-arrow-left mr-2"></i> Back to Subjects
            </button>
            <div class="ml-auto flex items-center bg-white rounded-full px-4 py-2 shadow-sm">
              <i class="fas fa-${getSubjectIcon(state.selectedSubject)} text-indigo-600 mr-2"></i>
              <span class="font-medium">${state.selectedSubject}</span>
            </div>
          </div>
          
          <h2 class="text-2xl font-bold text-gray-800 mb-2">Select Chapter</h2>
          <p class="text-gray-600 mb-6">Each chapter has its own quiz questions</p>
          
          <div class="space-y-4">
            ${chapters.map(ch => {
              const hasQuiz = subjectQuestions[ch.id] && subjectQuestions[ch.id].length > 0;
              const quizCount = hasQuiz ? subjectQuestions[ch.id].length : 0;
              const hasNotes = ch.notes && ch.notes.trim() !== '';
              
              return `
                <button class="w-full text-left bg-white rounded-xl p-5 shadow-sm card-hover flex items-center border border-transparent hover:border-indigo-200 transition-all duration-300"
                  onclick="onChapterSelect(${ch.id})"
                >
                  <div class="flex-shrink-0 w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-4">
                    <span class="text-indigo-600 font-semibold">${ch.id}</span>
                  </div>
                  <div class="flex-1">
                    <h3 class="font-semibold text-gray-800">${ch.title}</h3>
                    <div class="flex items-center text-sm text-gray-500 mt-1">
                      ${hasNotes ? '<span class="flex items-center mr-4"><i class="fas fa-book-open mr-1"></i> Notes</span>' : ''}
                      ${hasQuiz ? `<span class="flex items-center"><i class="fas fa-question-circle mr-1"></i> ${quizCount} Questions</span>` : '<span class="text-red-500">No Quiz</span>'}
                    </div>
                  </div>
                  <i class="fas fa-chevron-right text-gray-400 ml-2"></i>
                </button>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    // Chapter Options View
    function renderChapterOptions() {
      const chapter = getSelectedChapter();
      const hasNotes = chapter.notes && chapter.notes.trim() !== '';
      const hasQuiz = getCurrentQuizQuestions().length > 0;
      
      app.innerHTML = `
        <div class="flex flex-col fade-in">
          <div class="flex items-center mb-6">
            <button class="flex items-center text-indigo-600 hover:text-indigo-800 font-medium transition-colors" onclick="onBackToChapters()">
              <i class="fas fa-arrow-left mr-2"></i> Back to Chapters
            </button>
            <div class="ml-auto flex items-center bg-white rounded-full px-4 py-2 shadow-sm">
              <i class="fas fa-${getSubjectIcon(state.selectedSubject)} text-indigo-600 mr-2"></i>
              <span class="font-medium">${state.selectedSubject}</span>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">${chapter.title}</h2>
            <div class="flex items-center text-sm text-gray-500">
              ${hasQuiz ? `<span class="flex items-center mr-4"><i class="fas fa-question-circle mr-1"></i> ${getCurrentQuizQuestions().length} Quiz Questions</span>` : ''}
              ${hasNotes ? '<span class="flex items-center"><i class="fas fa-book-open mr-1"></i> Study Notes Available</span>' : ''}
            </div>
          </div>
          
          <div class="grid grid-cols-1 ${hasNotes ? 'md:grid-cols-2' : 'md:grid-cols-1'} gap-6">
            ${hasNotes ? `
              <button class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl p-6 shadow-md card-hover flex flex-col items-center justify-center h-40 focus:outline-none focus:ring-4 focus:ring-green-200 transition-all duration-300"
                onclick="onStudyNotes()"
              >
                <i class="fas fa-book-open text-3xl mb-3"></i>
                <span class="font-bold text-lg">Study Notes</span>
                <p class="text-green-100 text-sm mt-2 text-center">Read chapter notes</p>
              </button>
            ` : ''}
            
            ${hasQuiz ? `
              <button class="bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-xl p-6 shadow-md card-hover flex flex-col items-center justify-center h-40 focus:outline-none focus:ring-4 focus:ring-amber-200 transition-all duration-300"
                onclick="onPracticeQuiz()"
              >
                <i class="fas fa-question-circle text-3xl mb-3"></i>
                <span class="font-bold text-lg">Practice Quiz</span>
                <p class="text-amber-100 text-sm mt-2 text-center">Chapter-specific questions</p>
              </button>
            ` : `
              <div class="bg-gray-100 rounded-xl p-6 flex flex-col items-center justify-center h-40 opacity-75">
                <i class="fas fa-exclamation-triangle text-3xl mb-3 text-gray-400"></i>
                <span class="font-bold text-lg text-gray-500">No Quiz Available</span>
                <p class="text-gray-400 text-sm mt-2 text-center">No questions configured for this chapter</p>
              </div>
            `}
          </div>
        </div>
      `;
    }

    // Notes View
    function renderNotesView() {
      const notes = getSelectedChapter().notes || "No notes available for this chapter.";
      app.innerHTML = `
        <div class="flex flex-col fade-in">
          <div class="flex items-center mb-6">
            <button class="flex items-center text-indigo-600 hover:text-indigo-800 font-medium transition-colors" onclick="onBackFromNotes()">
              <i class="fas fa-arrow-left mr-2"></i> Back
            </button>
            <div class="ml-auto flex items-center bg-white rounded-full px-4 py-2 shadow-sm">
              <i class="fas fa-${getSubjectIcon(state.selectedSubject)} text-indigo-600 mr-2"></i>
              <span class="font-medium">${state.selectedSubject}</span>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">${getSelectedChapter().title}</h2>
            <div class="flex items-center text-sm text-gray-500">
              <i class="fas fa-book-open mr-2"></i>
              <span>Study Notes</span>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl p-6 shadow-sm max-h-[70vh] overflow-y-auto">
            <div class="prose max-w-none text-gray-700 whitespace-pre-line">
              ${notes}
            </div>
          </div>
        </div>
      `;
    }

    // Quiz Mode Selection View
    function renderQuizModeSelection() {
      const hasTimedTest = isTimedTestAllowed();
      const questions = getCurrentQuizQuestions();
      
      app.innerHTML = `
        <div class="flex flex-col max-w-md mx-auto fade-in">
          <div class="flex items-center mb-6">
            <button class="flex items-center text-indigo-600 hover:text-indigo-800 font-medium transition-colors" onclick="onBackToChapterOptions()">
              <i class="fas fa-arrow-left mr-2"></i> Back
            </button>
          </div>
          
          <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Chapter Quiz</h2>
            <p class="text-gray-600">${getSelectedChapter().title}</p>
            <p class="text-sm text-gray-500 mt-1">${questions.length} questions available</p>
          </div>
          
          <div class="bg-white rounded-2xl shadow-sm p-6">
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2" for="studentName">
                <i class="fas fa-user mr-2 text-indigo-500"></i>Your Name
              </label>
              <input id="studentName" type="text" placeholder="Enter your full name" 
                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-300 transition" />
            </div>
            
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-3">
                <i class="fas fa-tasks mr-2 text-indigo-500"></i>Quiz Mode
              </label>
              <div class="space-y-3">
                <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition option-card">
                  <input type="radio" name="quizMode" value="practice" checked class="mr-3 h-5 w-5 text-indigo-600 focus:ring-indigo-500" />
                  <div>
                    <span class="font-medium">Practice Mode (Flashcards)</span>
                    <p class="text-sm text-gray-500 mt-1">Review chapter questions at your own pace</p>
                  </div>
                </label>
                
                ${hasTimedTest ? `
                  <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition option-card">
                    <input type="radio" name="quizMode" value="timed" class="mr-3 h-5 w-5 text-indigo-600 focus:ring-indigo-500" />
                    <div>
                      <span class="font-medium">Timed Test (5 minutes)</span>
                      <p class="text-sm text-gray-500 mt-1">Test your chapter knowledge under time pressure</p>
                    </div>
                  </label>
                ` : `
                  <div class="p-3 border border-gray-200 rounded-lg bg-gray-50 opacity-75">
                    <div class="flex items-center">
                      <input type="radio" disabled class="mr-3 h-5 w-5 text-gray-400" />
                      <div>
                        <span class="font-medium text-gray-500">Timed Test</span>
                        <p class="text-sm text-gray-400 mt-1">Not available for this chapter</p>
                      </div>
                    </div>
                  </div>
                `}
              </div>
            </div>
            
            <button id="startQuizBtn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-3 rounded-lg hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-4 focus:ring-indigo-200 transition-all duration-300 shadow-md"
              onclick="onStartQuiz()"
            >
              <i class="fas fa-play mr-2"></i> Start Chapter Quiz
            </button>
          </div>
        </div>
      `;
    }

    // Practice Mode Flashcards
    function renderPracticeModeFlashcards() {
      const questions = getCurrentQuizQuestions();
      
      app.innerHTML = `
        <div class="flex flex-col fade-in">
          <div class="flex items-center mb-6">
            <button class="flex items-center text-indigo-600 hover:text-indigo-800 font-medium transition-colors" onclick="onBackToQuizModeSelection()">
              <i class="fas fa-arrow-left mr-2"></i> Back
            </button>
            <div class="ml-auto flex items-center bg-white rounded-full px-4 py-2 shadow-sm">
              <span class="font-medium">Chapter Practice</span>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">${getSelectedChapter().title}</h2>
            <p class="text-gray-600">Chapter-specific practice questions</p>
          </div>
          
          ${questions.length > 0 ? `
            <div class="space-y-6 max-h-[65vh] overflow-y-auto px-1">
              ${questions.map((q, i) => `
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                  <div class="flex items-start mb-4">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                      <span class="text-indigo-600 font-semibold text-sm">${i+1}</span>
                    </div>
                    <p class="font-semibold text-gray-800 flex-1">${q.question}</p>
                  </div>
                  
                  <div class="ml-11">
                    <ul class="space-y-2">
                      ${q.options.map((o, idx) => `
                        <li class="flex items-center ${idx === q.answer ? 'text-green-600 font-medium' : 'text-gray-700'}">
                          <span class="w-5 h-5 rounded-full border flex items-center justify-center mr-3 ${idx === q.answer ? 'bg-green-100 border-green-500' : 'border-gray-300'} text-xs">
                            ${String.fromCharCode(65 + idx)}
                          </span>
                          ${o} ${idx === q.answer ? '<i class="fas fa-check ml-2"></i>' : ''}
                        </li>
                      `).join('')}
                    </ul>
                  </div>
                </div>
              `).join('')}
            </div>
          ` : `
            <div class="bg-white rounded-2xl p-8 text-center">
              <i class="fas fa-exclamation-triangle text-amber-500 text-4xl mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-800 mb-2">No Questions Available</h3>
              <p class="text-gray-600">Quiz questions for this chapter are not configured yet.</p>
            </div>
          `}
        </div>
      `;
    }

    // Timed Test View
    function renderTimedTest() {
      if (state.testSubmitted) {
        renderTestResults();
        return;
      }

      const questions = getCurrentQuizQuestions();
      const qIndex = state.currentQuestionIndex ?? 0;
      const question = questions[qIndex];
      const progress = ((qIndex + 1) / questions.length) * 100;

      app.innerHTML = `
        <div class="flex flex-col max-w-2xl mx-auto fade-in">
          <div class="flex justify-between items-center mb-6">
            <button class="flex items-center text-indigo-600 hover:text-indigo-800 font-medium transition-colors" onclick="onAbortTest()">
              <i class="fas fa-times mr-2"></i> Cancel Test
            </button>
            <div class="flex items-center bg-red-100 text-red-700 px-4 py-2 rounded-full ${state.timerSecondsLeft <= 60 ? 'pulse-animation' : ''}">
              <i class="fas fa-clock mr-2"></i>
              <span class="font-bold" id="timerDisplay">${formatTime(state.timerSecondsLeft)}</span>
            </div>
          </div>
          
          <div class="mb-6">
            <div class="flex justify-between text-sm text-gray-600 mb-2">
              <span>Question ${qIndex + 1} of ${questions.length}</span>
              <span>${Math.round(progress)}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress}%"></div>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">${question.question}</h3>
            <form id="quizForm" class="space-y-3">
              ${question.options.map((opt, idx) => `
                <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer transition option-card ${state.testAnswers[qIndex] === idx ? 'selected' : ''}">
                  <input type="radio" name="answer" value="${idx}" class="mr-3 h-5 w-5 text-indigo-600 focus:ring-indigo-500" 
                    ${state.testAnswers[qIndex] === idx ? 'checked' : ''} />
                  <span class="flex-1">${opt}</span>
                </label>
              `).join('')}
            </form>
          </div>

          <div class="flex justify-between">
            <button class="bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center"
              id="prevBtn" ${qIndex === 0 ? 'disabled' : ''} onclick="onPrevQuestion()"
            >
              <i class="fas fa-arrow-left mr-2"></i> Previous
            </button>

            ${qIndex < questions.length -1
              ? `<button class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition flex items-center" onclick="onNextQuestion()">
                  Next <i class="fas fa-arrow-right ml-2"></i>
                </button>` 
              : `<button class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition flex items-center shadow-md" onclick="onSubmitTest()">
                  <i class="fas fa-paper-plane mr-2"></i> Submit Test
                </button>`
            }
          </div>
        </div>
      `;

      const form = document.getElementById('quizForm');
      form.addEventListener('change', e => {
        if (e.target.name === 'answer') {
          state.testAnswers[qIndex] = parseInt(e.target.value);
          render();
        }
      });

      if (!state.timerInterval) {
        state.timerInterval = setInterval(() => {
          state.timerSecondsLeft--;
          if (state.timerSecondsLeft <= 0) {
            clearInterval(state.timerInterval);
            state.timerInterval = null;
            onSubmitTest(true);
          } else {
            document.getElementById('timerDisplay').textContent = formatTime(state.timerSecondsLeft);
          }
        }, 1000);
      }
    }

    // Test Results View
    function renderTestResults() {
      const questions = getCurrentQuizQuestions();
      const score = calculateScore();
      const percentage = ((score / questions.length) * 100).toFixed(2);
      const now = new Date();
      const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const date = now.toLocaleDateString('en-GB');
      const day = now.toLocaleDateString('en-US', { weekday: 'long' });
      const weatherEmoji = "⛅";
      const resultStatus = score >= questions.length/2 ? "✅ Pass" : "❌ Fail";

      let telegramStatusMsg = '';
      if (state.telegramMessageStatus === 'success') {
        telegramStatusMsg = `<div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-4">
          <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 mr-2"></i>
            <span class="text-green-700 font-medium">Results successfully sent to Telegram.</span>
          </div>
        </div>`;
      } else if (state.telegramMessageStatus === 'error') {
        telegramStatusMsg = `<div class="bg-red-50 border border-red-200 rounded-lg p-4 mt-4">
          <div class="flex items-center">
            <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
            <span class="text-red-700 font-medium">Failed to send results to Telegram. Please check your internet connection.</span>
          </div>
        </div>`;
      } else {
        telegramStatusMsg = `<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
          <div class="flex items-center">
            <i class="fas fa-sync-alt animate-spin text-blue-500 mr-2"></i>
            <span class="text-blue-700 font-medium">Sending results to Telegram...</span>
          </div>
        </div>`;
      }

      app.innerHTML = `
        <div class="flex flex-col max-w-md mx-auto text-center fade-in">
          <div class="result-card p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">🎓 Chapter Result Card 🎓</h2>
            
            <div class="text-left space-y-3">
              <div class="flex items-center">
                <span class="w-8 text-lg">🧑‍🎓</span>
                <span class="font-medium">Name:</span>
                <span class="ml-2 font-semibold">${state.studentName}</span>
              </div>
              
              <div class="flex items-center">
                <span class="w-8 text-lg">📚</span>
                <span class="font-medium">Chapter:</span>
                <span class="ml-2 font-semibold">${getSelectedChapter().title}</span>
              </div>
              
              <div class="flex items-center">
                <span class="w-8 text-lg">💯</span>
                <span class="font-medium">Marks:</span>
                <span class="ml-2 font-semibold">${score} / ${questions.length}</span>
              </div>
              
              <div class="flex items-center">
                <span class="w-8 text-lg">📊</span>
                <span class="font-medium">Percentage:</span>
                <span class="ml-2 font-semibold">${percentage}%</span>
              </div>
              
              <div class="flex items-center">
                <span class="w-8 text-lg">🌟</span>
                <span class="font-medium">Result:</span>
                <span class="ml-2 font-semibold ${score >= questions.length/2 ? 'text-green-600' : 'text-red-600'}">${resultStatus}</span>
              </div>
            </div>
            
            <div class="result-divider"></div>
            
            <div class="text-sm text-gray-600">
              <p>Chapter test checked and verified.</p>
              <div class="flex justify-center items-center mt-2 space-x-4">
                <span>🕐 Time: ${time}</span>
                <span>📆 Date: ${date} ${weatherEmoji} ${day}</span>
              </div>
            </div>
            
            ${telegramStatusMsg}
            
            <button class="mt-8 w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-3 rounded-lg hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-4 focus:ring-indigo-200 transition-all duration-300 shadow-md"
              onclick="onReturnToSubjects()"
            >
              <i class="fas fa-home mr-2"></i> Return to Subjects
            </button>
          </div>
        </div>
      `;
    }

    // =============================================
    // EVENT HANDLERS - NO NEED TO EDIT
    // =============================================
    
    window.onSubjectSelect = (subject) => {
      state.selectedSubject = subject;
      state.currentView = 'chapterList';
      render();
    };

    window.onBackToSubjects = () => {
      state.selectedSubject = null;
      state.currentView = 'subjectSelection';
      render();
    };

    window.onChapterSelect = (chapterId) => {
      state.selectedChapter = chapterId;
      state.currentView = 'chapterOptions';
      render();
    };

    window.onBackToChapters = () => {
      state.selectedChapter = null;
      state.currentView = 'chapterList';
      render();
    };

    window.onStudyNotes = () => {
      state.currentView = 'notesView';
      render();
    };

    window.onBackFromNotes = () => {
      state.currentView = 'chapterOptions';
      render();
    };

    window.onPracticeQuiz = () => {
      state.currentView = 'quizModeSelection';
      render();
    };

    window.onBackToChapterOptions = () => {
      state.currentView = 'chapterOptions';
      render();
    };

    window.onBackToQuizModeSelection = () => {
      state.currentView = 'quizModeSelection';
      render();
    };

    window.onStartQuiz = () => {
      const nameInput = document.getElementById('studentName');
      const modeInput = document.querySelector('input[name="quizMode"]:checked');
      
      if (!nameInput.value.trim()) {
        alert("Please enter your name.");
        nameInput.focus();
        return;
      }
      
      const questions = getCurrentQuizQuestions();
      if (questions.length === 0) {
        alert("No quiz questions available for this chapter.");
        return;
      }
      
      state.studentName = nameInput.value.trim();
      state.selectedMode = modeInput ? modeInput.value : 'practice';

      if (state.selectedMode === 'practice') {
        state.currentView = 'practiceModeFlashcards';
        render();
        return;
      }

      if (!isTimedTestAllowed()) {
        alert("Timed Test is not available for this chapter.");
        return;
      }

      state.currentView = 'timedTest';
      state.currentQuestionIndex = 0;
      state.testAnswers = Array(questions.length).fill(null);
      state.timerSecondsLeft = 300;
      state.testSubmitted = false;
      state.telegramMessageStatus = null;
      render();
    };

    window.onPrevQuestion = () => {
      if (state.currentQuestionIndex > 0) {
        state.currentQuestionIndex--;
        render();
      }
    };

    window.onNextQuestion = () => {
      if (state.currentQuestionIndex < getCurrentQuizQuestions().length - 1) {
        state.currentQuestionIndex++;
        render();
      }
    };

    window.onSubmitTest = (autoSubmit = false) => {
      const questions = getCurrentQuizQuestions();
      
      if (!autoSubmit) {
        for (let i = 0; i < questions.length; i++) {
          if (state.testAnswers[i] === null) {
            alert(`Please answer question ${i + 1} before submitting.`);
            state.currentQuestionIndex = i;
            render();
            return;
          }
        }
      }
      clearTimer();
      state.testSubmitted = true;
      state.currentView = 'testResults';
      render();

      sendResultsToTelegram();
    };

    window.onAbortTest = () => {
      if (confirm("Are you sure you want to cancel the test? Your progress will be lost.")) {
        clearTimer();
        state.testSubmitted = false;
        state.testAnswers = Array(getCurrentQuizQuestions().length).fill(null);
        state.timerSecondsLeft = 300;
        state.currentView = 'quizModeSelection';
        render();
      }
    };

    window.onReturnToSubjects = () => {
      clearTimer();
      state.selectedSubject = null;
      state.selectedChapter = null;
      state.selectedMode = null;
      state.studentName = '';
      state.testAnswers = [];
      state.timerSecondsLeft = 300;
      state.testSubmitted = false;
      state.telegramMessageStatus = null;
      state.currentView = 'subjectSelection';
      render();
    };

    function calculateScore() {
      const questions = getCurrentQuizQuestions();
      let score = 0;
      for (let i = 0; i < questions.length; i++) {
        if (state.testAnswers[i] === questions[i].answer) score++;
      }
      return score;
    }

    async function sendResultsToTelegram() {
      const questions = getCurrentQuizQuestions();
      const score = calculateScore();
      const percentage = ((score / questions.length) * 100).toFixed(2);
      const now = new Date();
      const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const date = now.toLocaleDateString('en-GB');
      const day = now.toLocaleDateString('en-US', { weekday: 'long' });
      const weatherEmoji = "⛅";
      const resultStatus = score >= questions.length/2 ? "✅ Pass" : "❌ Fail";

      const resultText =
        `🎓 Chapter Result Card 🎓
--------------------------------------
🧑‍🎓 Name: ${escapeHtml(state.studentName)}
📚 Chapter: ${escapeHtml(getSelectedChapter().title)}
💯 Marks: ${score} / ${questions.length}
📊 Percentage: ${percentage}%
🌟 Result: ${resultStatus}
--------------------------------------
Chapter test checked and verified.
🕐 Time: ${time}
📆 Date: ${date} ${weatherEmoji} ${day}`;

      try {
        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text: resultText
          }),
        });
        const data = await response.json();
        if (!response.ok) {
          console.error("Telegram API error:", data);
          state.telegramMessageStatus = 'error';
        } else {
          state.telegramMessageStatus = 'success';
        }
      } catch (error) {
        console.error("Fetch error:", error);
        state.telegramMessageStatus = 'error';
      }
      renderTestResults();
    }

    // Initial render
    render();

      if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/NAV_Education/service-worker.js')
    .then(function(registration) {
      console.log('Service Worker registered with scope:', registration.scope);
    })
    .catch(function(error) {
      console.error('Service Worker registration failed:', error);
    });
          
    }
// Highlight matching part in results
function highlightQuery(text, query) {
  if (!query) return text;
  const re = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'ig');
  return text.replace(re, '<mark>$1</mark>');
}

// Attach search functionality
document.addEventListener('DOMContentLoaded', () => {
  // Delegate because the search box is re-rendered
  document.body.addEventListener('input', function(e) {
    if (e.target && e.target.id === 'globalSearchInput') {
      const query = e.target.value;
      const results = performSearch(query);
      const resultsDiv = document.getElementById('globalSearchResults');
      if (query && results.length) {
        resultsDiv.innerHTML = results.slice(0, 20).map(item => `
          <div class="p-3 border-b border-gray-100 hover:bg-indigo-50 cursor-pointer" onclick="onSearchResultClick('${item.subject}', ${item.ref.chapterId || 1}, '${item.type}')">
            <div class="text-sm text-gray-700">${highlightQuery(item.display, query)}</div>
            <div class="text-xs text-gray-400">${item.type}</div>
          </div>
        `).join('');
        resultsDiv.classList.remove('hidden');
      } else if (query) {
        resultsDiv.innerHTML = `<div class="p-3 text-gray-400 text-sm">No results found.</div>`;
        resultsDiv.classList.remove('hidden');
      } else {
        resultsDiv.innerHTML = '';
        resultsDiv.classList.add('hidden');
      }
    }
  });
  // Hide on click away
  document.body.addEventListener('click', (e) => {
    if (!e.target.closest('#globalSearchForm') && !e.target.closest('#globalSearchResults')) {
      const resultsDiv = document.getElementById('globalSearchResults');
      if (resultsDiv) resultsDiv.classList.add('hidden');
    }
  });
});

// Result click handler
window.onSearchResultClick = function(subject, chapterId, type) {
  state.selectedSubject = subject;
  state.selectedChapter = chapterId;
  if (type === 'Notes') {
    state.currentView = 'notesView';
  } else if (type === 'Chapter') {
    state.currentView = 'chapterOptions';
  } else {
    state.currentView = 'chapterOptions';
  }
  render();
  // Clear results after navigation
  const resultsDiv = document.getElementById('globalSearchResults');
  if (resultsDiv) resultsDiv.classList.add('hidden');
  const input = document.getElementById('globalSearchInput');
  if (input) input.value = '';
};
    
    resultsDiv.innerHTML = results.slice(0, 20).map(item => `
  <div class="p-3 border-b border-gray-100 hover:bg-indigo-50 cursor-pointer"
    ${item.url ? `onclick="window.open('${item.url}', '_blank')"` : `onclick="onSearchResultClick('${item.subject}', null, '${item.type}')"`}>
    <div class="text-sm text-gray-700">${highlightQuery(item.display, query)}</div>
    <div class="text-xs text-gray-400">${item.type}</div>
  </div>
`).join('');
  </script>

</body>
</html>
