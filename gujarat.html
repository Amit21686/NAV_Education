<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interactive Gujarat Map</title>
    <style>
        /* RESET */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #fff; overflow: hidden; font-family: sans-serif; }

        /* COMPACT TOP BAR */
        #top-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(255, 255, 255, 0.98); border-bottom: 1px solid #ddd;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; z-index: 1000;
        }

        /* ICON BUTTONS */
        .icon-btn {
            background: none; border: none; cursor: pointer; padding: 8px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: background 0.2s;
        }
        .icon-btn:active { background: #f0f0f0; }
        .icon-btn svg { width: 24px; height: 24px; fill: #333; }
        
        #mode-btn svg { fill: #6c5ce7; }
        #undo-btn svg { fill: #ff4757; }
        #restart-btn svg { fill: #00b894; }

        /* SCORE BOARD */
        #score-board {
            font-size: 16px; font-weight: 800; color: #2d3436;
            margin-right: 10px; min-width: 60px; text-align: right;
            display: none; 
        }

        /* MAGIC BOX */
        #magic-box {
            background: #f0f4f8; border: 2px solid #007bff; color: #007bff;
            padding: 6px 14px; border-radius: 18px; font-weight: 700; font-size: 14px;
            text-align: center; cursor: default; flex-grow: 1; margin: 0 10px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            max-width: 200px;
            background: #007bff; color: white;
            box-shadow: 0 2px 5px rgba(0,123,255,0.3);
        }
        
        #magic-box.correct { background: #2ecc71 !important; border-color: #2ecc71 !important; }
        #magic-box.wrong { background: #e74c3c !important; border-color: #e74c3c !important; animation: shake 0.4s; }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
        }

        /* MAP CONTAINER */
        #scroll-container {
            width: 100%; height: 100%; overflow: auto; position: relative;
            touch-action: pan-x pan-y; background: #fff; padding-top: 60px;
        }
        #map-content { position: relative; transform-origin: 0 0; will-change: width, height; }
        #map-image { display: block; width: 100%; height: 100%; object-fit: contain; pointer-events: none; }

        /* DOTS & LABELS */
        .map-label {
            position: absolute; transform: translate(-50%, -7px);
            display: flex; flex-direction: column; align-items: center;
            z-index: 10; cursor: pointer; transition: transform 0.1s;
        }
        .label-dot {
            width: 14px; height: 14px; background: #b2bec3;
            border: 2px solid #fff; border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4); margin-bottom: 2px;
        }
        .teacher-mode .label-dot { background: #0984e3; }
        .label-text {
            background: rgba(255,255,255,0.95); border: 1px solid #333;
            padding: 1px 5px; border-radius: 4px; font-size: 11px; color: #000;
            white-space: nowrap; font-weight: 700; display: none;
        }
        .teacher-mode .label-text { display: block; }
        .map-label.solved .label-dot { background: #2ecc71 !important; }
        .map-label.solved .label-text { display: block !important; }
        .map-label.error .label-dot { background: #e74c3c !important; }

        .controls-group { display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body>

    <!-- TOP BAR -->
    <div id="top-bar">
        <!-- Left: Mode & Restart -->
        <div class="controls-group">
            <button id="mode-btn" class="icon-btn" title="Switch Mode">
                <svg viewBox="0 0 24 24"><path d="M20 17.27V6.73c0-1.1-.9-2-2-2H6c-1.1 0-2 .9-2 2v10.55c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2.01zM6 17.27V6.73H18v10.54H6z"/><path d="M16 12h-3V9h-2v3H8v2h3v3h2v-3h3z"/></svg>
            </button>
            <button id="restart-btn" class="icon-btn" title="Restart / Clear">
                <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            </button>
        </div>

        <!-- Center: Magic Box -->
        <div id="magic-box">Tap to Start</div>

        <!-- Right: Score or Undo -->
        <div class="controls-group">
            <div id="score-board">0</div>
            <button id="undo-btn" class="icon-btn" title="Undo Last">
                <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
            </button>
        </div>
    </div>

    <!-- MAP -->
    <div id="scroll-container">
        <div id="map-content" class="teacher-mode">
            <img id="map-image" src="https://iili.io/flPSdMB.jpg" alt="Gujarat Map">
        </div>
    </div>

<script>
    /** ICONS */
    const ICON_TEACHER = `<svg viewBox="0 0 24 24"><path d="M20 17.27V6.73c0-1.1-.9-2-2-2H6c-1.1 0-2 .9-2 2v10.55c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2.01zM6 17.27V6.73H18v10.54H6z"/><path d="M16 12h-3V9h-2v3H8v2h3v3h2v-3h3z"/></svg>`;
    const ICON_STUDENT = `<svg viewBox="0 0 24 24"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>`;

    /** DATA */
    const GUJARAT_DISTRICTS = [
            "Ahmedabad", "Amreli", "Morbi", "Anand", "Aravalli", "Banaskantha", "Bharuch", "Bhavnagar", "Botad",
      "Chhota Udaipur", "Dahod", "Dang", "Gandhinagar", "Gir Somnath", "Jamnagar", "Junagadh",
      "Kheda", "Kutch", "Mahisagar", "Narmada", "Navsari", "Panchmahal", "Patan", "Porbandar",
      "Rajkot", "Sabarkantha", "Surat", "Surendranagar", "Tapi", "Mehsana" , "Devbhoomi Dwarka" , "Vav Tharad" , "Vadodara", "Valsad"
    ];
    const STORAGE_KEY = 'gujarat_map_teacher_data';

    /** STATE */
    let isTeacherMode = true;
    let teacherData = [];
    let studentSolvedIds = []; 
    let currentScore = 0;
    
    let availableStates = [];
    let currentTargetState = null;
    let isWaitingForPlacement = false;

    let minCoverWidth = 0;
    let maxZoomWidth = 0;

    /** DOM */
    const mapContent = document.getElementById('map-content');
    const magicBox = document.getElementById('magic-box');
    const undoBtn = document.getElementById('undo-btn');
    const modeBtn = document.getElementById('mode-btn');
    const restartBtn = document.getElementById('restart-btn');
    const scoreBoard = document.getElementById('score-board');
    const mapImage = document.getElementById('map-image');
    const scrollContainer = document.getElementById('scroll-container');

    function init() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) teacherData = JSON.parse(saved);

        studentSolvedIds = [];
        currentScore = 0;

        setMode(false); 

        if (mapImage.complete) setupDimensions();
        else mapImage.onload = setupDimensions;
    }

    function setupDimensions() {
        const imgW = mapImage.naturalWidth || 1000;
        const imgH = mapImage.naturalHeight || 1000;
        const screenW = window.innerWidth;
        const screenH = window.innerHeight;
        minCoverWidth = Math.max(screenW, screenH * (imgW / imgH));
        maxZoomWidth = minCoverWidth * 3;
        mapContent.style.width = `${minCoverWidth}px`;
        mapContent.style.height = 'auto';
    }

    /** MODES */
    function setMode(teacher) {
        isTeacherMode = teacher;
        modeBtn.innerHTML = isTeacherMode ? ICON_TEACHER : ICON_STUDENT;
        
        undoBtn.style.display = isTeacherMode ? "flex" : "none";
        scoreBoard.style.display = isTeacherMode ? "none" : "block";
        restartBtn.style.display = "flex"; 
        
        if(isTeacherMode) {
            mapContent.classList.add('teacher-mode');
        } else {
            mapContent.classList.remove('teacher-mode');
        }

        resetGameCycle();
    }

    modeBtn.addEventListener('click', () => setMode(!isTeacherMode));
    
    restartBtn.addEventListener('click', () => {
        if (isTeacherMode) {
            if(!confirm("âš  WARNING: Clear entire map?")) return;
            teacherData = [];
            saveTeacher();
            resetGameCycle();
        } else {
            if(!confirm("Restart student session?")) return;
            studentSolvedIds = [];
            currentScore = 0;
            scoreBoard.textContent = "0";
            resetGameCycle();
        }
    });

    /** GAME LOOP */
    function resetGameCycle() {
        currentTargetState = null;
        isWaitingForPlacement = false;
        magicBox.className = "";
        
        resetAvailableStates();
        renderLabels();
        updateMagicBox(); 
    }

    function resetAvailableStates() {
        if (isTeacherMode) {
            const placed = teacherData.map(l => l.name);
            availableStates = GUJARAT_DISTRICTS.filter(s => !placed.includes(s));
        } else {
            const placed = teacherData.map(l => l.name);
            const solved = teacherData.filter(l => studentSolvedIds.includes(l.id)).map(l => l.name);
            availableStates = placed.filter(s => !solved.includes(s));
        }
    }

    function pickRandom() {
        resetAvailableStates();
        if (availableStates.length === 0) return null;
        return availableStates[Math.floor(Math.random() * availableStates.length)];
    }

    function updateMagicBox() {
        if (availableStates.length === 0) {
            magicBox.textContent = isTeacherMode ? "Map Complete!" : "You Won!";
            magicBox.classList.remove('active'); 
            isWaitingForPlacement = false;
            return;
        }

        if (!currentTargetState) {
            currentTargetState = pickRandom();
        }

        magicBox.textContent = isTeacherMode ? `Place: ${currentTargetState}` : `Find: ${currentTargetState}`;
        isWaitingForPlacement = true;
    }

    /** TEACHER LOGIC */
    undoBtn.addEventListener('click', () => {
        if (!isTeacherMode || teacherData.length === 0) return;
        teacherData.pop();
        saveTeacher();
        resetGameCycle();
    });

    mapContent.addEventListener('click', (e) => {
        if (isTeacherMode && isWaitingForPlacement) {
            if (e.target.closest('.map-label')) return;
            const rect = mapContent.getBoundingClientRect();
            teacherData.push({
                id: Date.now(),
                name: currentTargetState,
                x: ((e.clientX - rect.left) / rect.width) * 100,
                y: ((e.clientY - rect.top) / rect.height) * 100
            });
            saveTeacher();
            resetGameCycle();
        }
    });

    function saveTeacher() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(teacherData));
    }

    /** RENDERING & INTERACTION */
    function renderLabels() {
        document.querySelectorAll('.map-label').forEach(el => el.remove());
        teacherData.forEach(data => {
            const el = document.createElement('div');
            el.className = 'map-label';
            if (studentSolvedIds.includes(data.id)) el.classList.add('solved');
            el.style.left = `${data.x}%`;
            el.style.top = `${data.y}%`;
            
            el.innerHTML = `<div class="label-dot"></div><div class="label-text">${data.name}</div>`;
            
            if (isTeacherMode) attachTeacherEvents(el, data.id);
            else attachStudentEvents(el, data);
            
            mapContent.appendChild(el);
        });
    }

    function attachTeacherEvents(el, id) {
        let timer;
        const start = () => {
            timer = setTimeout(() => {
                try { if(navigator.vibrate) navigator.vibrate(100); } catch(e){}
                teacherData = teacherData.filter(l => l.id !== id);
                saveTeacher();
                resetGameCycle();
            }, 600);
        };
        const cancel = () => clearTimeout(timer);
        el.addEventListener('touchstart', start, {passive:true});
        el.addEventListener('touchend', cancel);
        el.addEventListener('mousedown', start);
        el.addEventListener('mouseup', cancel);
    }

    function attachStudentEvents(el, data) {
        el.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!isWaitingForPlacement || studentSolvedIds.includes(data.id)) return;
            
            if (data.name === currentTargetState) {
                // Correct
                studentSolvedIds.push(data.id);
                currentScore++;
                scoreBoard.textContent = currentScore;
                magicBox.classList.add('correct');
                magicBox.textContent = "Correct!";
                renderLabels();
                
                setTimeout(() => resetGameCycle(), 800);
            } else {
                // Wrong
                el.classList.add('error');
                magicBox.classList.add('wrong');
                magicBox.textContent = "Try Again!";
                
                // DOUBLE VIBRATION PULSE FOR WRONG ANSWER (100ms, pause 50ms, 100ms)
                try { 
                    if(navigator.vibrate) {
                        navigator.vibrate([100, 50, 100]); 
                    }
                } catch(e){}
                
                setTimeout(() => {
                    el.classList.remove('error');
                    magicBox.classList.remove('wrong');
                    magicBox.textContent = `Find: ${currentTargetState}`;
                }, 800);
            }
        });
    }

    /** ZOOM */
    let startDist=0, startWidth=0, isPinching=false;
    scrollContainer.addEventListener('touchstart', e => {
        if(e.touches.length === 2) {
            isPinching=true;
            startDist = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
            startWidth = mapContent.getBoundingClientRect().width;
            e.preventDefault();
        }
    }, {passive:false});

    scrollContainer.addEventListener('touchmove', e => {
        if(isPinching && e.touches.length === 2) {
            e.preventDefault();
            const dist = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
            let newW = startWidth * (dist/startDist);
            newW = Math.min(Math.max(newW, minCoverWidth), maxZoomWidth);
            
            const midX = (e.touches[0].clientX+e.touches[1].clientX)/2;
            const midY = (e.touches[0].clientY+e.touches[1].clientY)/2;
            const ratioX = (scrollContainer.scrollLeft + midX) / mapContent.offsetWidth;
            const ratioY = (scrollContainer.scrollTop + midY - 60) / mapContent.offsetHeight;

            mapContent.style.width = `${newW}px`;
            
            scrollContainer.scrollLeft = (ratioX * mapContent.offsetWidth) - midX;
            scrollContainer.scrollTop = (ratioY * mapContent.offsetHeight) - midY + 60;
        }
    }, {passive:false});
    
    scrollContainer.addEventListener('touchend', e => { if(e.touches.length < 2) isPinching=false; });
    window.addEventListener('resize', setupDimensions);

    init();
</script>
</body>
</html>